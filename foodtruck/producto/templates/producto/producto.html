{% extends 'restaurante/base.html' %}
<!-- Nombre en la pestaÃ±a-->
{% block title %}{{restaurante.name}}{% endblock %}
<!-- Contenido-->
{% block content %}
    
    <h1>PRODUCTOS</h1>

<div class="contenedor-mayor">
   <div class="contenedor-flex">
    {% for producto in productos %}
      <div class="cardp" data-id="{{ producto.id }}" data-name="{{ producto.name }}" data-price="{{ producto.price }}" data-description="{{ producto.description }}" data-image="{{ producto.image.url }}">
          <div class="cardp-inner">
              <div class="cardp-front">
                  {% if producto.image %}
                    <img class="img-productof" src="{{ producto.image.url }}" alt="Card image cap">
                  {% endif %}
                  <div>
                      <h5>{{ producto.name }}</h5>
                      <h6>${{ producto.price }} COP</h6>
                      {% if producto.description %}
                        <p>{{ producto.description }}</p>
                      {% endif %}
                  </div>
              </div>
              <div class="cardp-back">
                  <img class="img-productoback" src="{{ producto.image.url }}" alt="Card image cap">
                  <div class="seleccion-producto">
                    <div class="product-quantity-section">
                      <label for="producto-cantidad-{{ producto.id }}">Cantidad:</label>
                      <input type="number" id="producto-cantidad-{{ producto.id }}" class="producto-cantidad-input" min="1" value="1">
                    </div>
                    <div class="contenedor-botones">
                      <button class="boton-agregar-producto">Agregar</button>
                      <button class="boton-volver-producto">Volver</button>
                  </div>
                </div>
              </div>
          </div>
        </div>
    {% endfor %}
  </div> 

    <div class="panel-seleccion">
      <h2>PEDIDO</h2>
      <h5>{{ restaurante.name }}</h5>

      <form method="post">
        {% csrf_token %}
        {{ pedido_form.as_p }}
        {{ detalle_pedido_formset.management_form }}
        
          <div id="productos-seleccionados">
            <p>Cliente</p>
            <p>Restaurante</p>
            
            <thead class="tabla-pedido">
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Total</th>
              </tr>
            </thead>
          </div>
        
          <h3>Total: <span id="total-pedido">0</span> COP</h3>
          <button type="submit">Realizar pedido</button>
        </form>
    </div>

<script>
let diccionario = {};

document.addEventListener('DOMContentLoaded', function () {
    let diccionarioJSON = localStorage.getItem("miDiccionario");

    if (diccionarioJSON) {
        diccionario = JSON.parse(diccionarioJSON);
    }

    const flipCardButtons = document.querySelectorAll('.boton-volver-producto');
    const selectButtons = document.querySelectorAll('.boton-agregar-producto');
    const selectedProductsContainer = document.getElementById('productos-seleccionados');
    const totalPedido = document.getElementById('total-pedido');

    function actualizarListaProductos() {
        let total = 0;
        selectedProductsContainer.innerHTML = `
          <thead class="tabla-pedido">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Cantidad</th>
              <th>Total</th>
            </tr>
          </thead>
        `;
        
        let index = 0;
        for (let [productoId, productoData] of Object.entries(diccionario)) {
            let div = document.createElement('div');
            let subtotal = productoData.quantity * productoData.price;
            total += subtotal;

            div.innerHTML = `
                <input type="hidden" name="detallepedido_set-${index}-producto" value="${productoId}">
                <input type="hidden" name="detallepedido_set-${index}-cantidad" value="${productoData.quantity}">
                <input type="hidden" name="detallepedido_set-${index}-observaciones" value="sin observaciones">
                <tr>
                    <td>${productoId}</td>
                    <td>${productoData.name}</td>
                    <td>${productoData.price} COP</td>
                    <td>${productoData.quantity}</td>
                    <td>${subtotal} COP</td>
                </tr>
            `;
            selectedProductsContainer.appendChild(div);
            index++;
        }

        totalPedido.textContent = total;

        let totalForms = document.createElement('input');
        totalForms.type = 'hidden';
        totalForms.name = 'detallepedido_set-TOTAL_FORMS';
        totalForms.value = index;

        selectedProductsContainer.appendChild(totalForms);
    }

    selectButtons.forEach(button => {
        button.addEventListener('click', function () {
            const productCard = this.closest('.cardp');
            const productId = productCard.getAttribute('data-id');
            const productName = productCard.getAttribute('data-name');
            const productPrice = productCard.getAttribute('data-price');
            const quantityInput = productCard.querySelector('.producto-cantidad-input');
            const quantity = parseInt(quantityInput.value, 10);

            if (quantity <= 0) return;

            if (productId in diccionario) {
                diccionario[productId].quantity += quantity;
            } else {
                diccionario[productId] = {
                    name: productName,
                    price: parseFloat(productPrice),
                    quantity: quantity
                };
            }

            localStorage.setItem("miDiccionario", JSON.stringify(diccionario));
            actualizarListaProductos();
        });
    });

    actualizarListaProductos();
});
</script>

{% endblock %}
